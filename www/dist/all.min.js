var openFB=function(){function e(e){if(!e.appId)throw"appId parameter not set in init()";p=e.appId,e.tokenStore&&(f=e.tokenStore)}function t(e){var t=f.fbtoken,n={};t?(n.status="connected",n.authResponse={token:t}):n.status="unknown",e&&e(n)}function n(e,t){function n(e){var t=e.url;if(t.indexOf("access_token=")>0||t.indexOf("error=")>0){var n=600-((new Date).getTime()-s);setTimeout(function(){r.close()},n>0?n:0),o(t)}}function a(){console.log("exit and remove listeners"),deferredLogin.reject({error:"user_cancelled",error_description:"User cancelled login process",error_reason:"user_cancelled"}),r.removeEventListener("loadstop",n),r.removeEventListener("exit",a),r=null,console.log("done removing listeners")}var r,s,i="";return p?(t&&t.scope&&(i=t.scope),l=e,d=!1,u&&(k="https://www.facebook.com/connect/login_success.html"),s=(new Date).getTime(),r=window.open(g+"?client_id="+p+"&redirect_uri="+k+"&response_type=token&scope="+i,"_blank","location=no"),void(u&&(r.addEventListener("loadstart",n),r.addEventListener("exit",a)))):e({status:"unknown",error:"Facebook App Id not set."})}function o(e){var t,n;d=!0,e.indexOf("access_token=")>0?(t=e.substr(e.indexOf("#")+1),n=i(t),f.fbtoken=n.access_token,l&&l({status:"connected",authResponse:{token:n.access_token}})):e.indexOf("error=")>0?(t=e.substring(e.indexOf("?")+1,e.indexOf("#")),n=i(t),l&&l({status:"not_authorized",error:n.error})):l&&l({status:"not_authorized"})}function a(e){var t,n=f.fbtoken;f.removeItem("fbtoken"),n&&(t=window.open(m+"?access_token="+n+"&next="+v,"_blank","location=no"),u&&setTimeout(function(){t.close()},700)),e&&e()}function r(e){var t,n=e.method||"GET",o=e.params||{},a=new XMLHttpRequest;o.access_token=f.fbtoken,t="https://graph.facebook.com"+e.path+"?"+c(o),a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status)e.success&&e.success(JSON.parse(a.responseText));else{var t=a.responseText?JSON.parse(a.responseText).error:{message:"An error has occurred"};e.error&&e.error(t)}},a.open(n,t,!0),a.send()}function s(e,t){return r({method:"DELETE",path:"/me/permissions",success:function(){f.fbtoken=void 0,e()},error:t})}function i(e){var t=decodeURIComponent(e),n={},o=t.split("&");return o.forEach(function(e){var t=e.split("=");n[t[0]]=t[1]}),n}function c(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}var l,u,d,g="https://www.facebook.com/dialog/oauth",m="https://www.facebook.com/logout.php",f=window.sessionStorage,p="648798351882921",h=window.location.pathname.substring(0,window.location.pathname.indexOf("/",2)),S=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+h,k=S+"/oauthcallback.html",v=S+"/logoutcallback.html";return console.log(k),console.log(v),document.addEventListener("deviceready",function(){u=!0},!1),{init:e,login:n,logout:a,revokePermissions:s,api:r,oauthCallback:o,getLoginStatus:t}}();angular.module("starter",["ionic","starter.controllers","starter.services"]).run(function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault()})}).config(function(e,t,n){n.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|mailto|file):/),n.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file):/),e.state("frontPage",{url:"/",templateUrl:"frontPage/frontPage.html",controller:"FrontPageCtrl"}).state("friends",{url:"/friends",templateUrl:"pages/friends/friends.html",controller:"FriendsCtrl"}).state("game",{url:"/game",templateUrl:"pages/game/game.html",controller:"GameCtrl"}).state("results",{url:"/results",templateUrl:"pages/results/results.html",controller:"ResultsCtrl"}).state("hanziOptions",{url:"/hanziOptions",templateUrl:"pages/hanziOptions/hanziOptions.html",controller:"HanziOptionsCtrl"}).state("deckOptions",{url:"/deckOptions",templateUrl:"pages/deckOptions/deckOptions.html",controller:"DeckOptionsCtrl"}).state("logout",{url:"/logout",controller:"LogoutCtrl"}),t.otherwise("/")}),angular.module("starter.controllers",["starter.frontPage","starter.friends","starter.game","starter.results","starter.hanziOptions","starter.deckOptions"]).controller("MenuController",function(e,t){e.list=t.all(),e.user=localStorage.getItem("FBuserName")||""}).controller("LogoutCtrl",function(e,t){openFB.logout(function(){window.localStorage.clear(),t.go("frontPage")})}),angular.module("starter.services",[]).factory("MenuService",function(){var e=[{text:"Home",iconClass:"icon ion-map",link:"friends"},{text:"Friends",iconClass:"icon ion-map",link:"friends"},{text:"Options",iconClass:"icon ion-map",link:"hanziOptions"},{text:"Logout",iconClass:"icon ion-map",link:"logout"}];return{all:function(){return e}}}).factory("LS",function(e,t){return angular.element(e).on("storage",function(e){"hanziOptions"===e.key&&t.apply()}),{setData:function(t){return e.localStorage&&e.localStorage.setItem("hanziOptions",t),this},getData:function(){return e.localStorage&&e.localStorage.getItem("hanziOptions")}}}).factory("Friends",function(e){var t=[{id:0,name:"Scruff McGruff"},{id:1,name:"G.I. Joe"},{id:2,name:"Miss Frizzle"},{id:3,name:"Ash Ketchum"}],n=function(t){return e({method:"GET",url:"/api/users/"+t+"/friendslist"})},o=function(t){return e({method:"GET",url:"/api/users/"+t+"/challenges"}).then(function(e){return e.data})};return{all:function(){return t},getFriends:n,getChallenges:o}}).factory("Game",function(e){var t=function(t){return e({method:"POST",data:t,url:"/api/games/creategame"})},n=function(t){return e({method:"GET",url:"/api/games/"+t+"/getgame"})},o=function(t,n){return e({method:"POST",data:n,url:"/api/games/"+t+"/updatescore"})};return{makeGame:t,getGame:n,update:o}}).factory("DeckOptions",function(){var e=[{id:0,name:"HSK"},{id:1,name:"Custom1"},{id:2,name:"Custom2"},{id:3,name:"Custom3"}];return{all:function(){return e}}}).factory("Auth",function(e,t){var n=function(t){return e({method:"POST",url:"/api/users/signin",data:t}).then(function(e){return e.data})},o=function(e){openFB.getLoginStatus(function(n){"connected"===n.status?e():t.go("frontPage")})};return{signin:n,checkLoginStatus:o}}).factory("User",function(e){var t=function(t){return e({method:"GET",url:"/api/users/"+t}).then(function(e){return e.data})};return{userInfo:t}}),angular.module("starter.frontPage",[]).controller("FrontPageCtrl",function(e,t){openFB.getLoginStatus(function(n){"connected"===n.status?t.go("friends"):e.login=function(){openFB.login(function(e){"connected"===e.status?openFB.api({path:"/me",success:function(e){window.localStorage.setItem("FBuserID",e.id),window.localStorage.setItem("FBuserName",e.name),window.localStorage.setItem("FBuserLocale",e.locale),openFB.api({path:"/me/picture",params:{redirect:!1},success:function(e){window.localStorage.setItem("FBuserPic",e.data.url),t.go("friends")},error:function(e){console.log(e)}})},error:function(e){console.log(e)}}):alert("Facebook login failed: "+e.error)},{scope:"email, user_friends"})}})}),angular.module("starter.deckOptions",[]).controller("DeckOptionsCtrl",function(e,t){e.enter=function(){t.go("tab.account")}}),angular.module("starter.friends",[]).controller("FriendsCtrl",function(e,t,n,o,a,r,s,i){s.checkLoginStatus(function(){e.getFriends=o.getFriends,e.makeGame=a.makeGame,e.data={},e.buttonText={start:"Start Game",challenged:"Waiting for opponent",creator:"Accept Challenge"};var c=localStorage.getItem("FBuserID"),l=localStorage.getItem("FBuserPic");e.data.user=localStorage.getItem("FBuserName")||"","undefined"===c||"undefined"===e.data.user?console.log("undefined user"):s.signin({facebookId:c,username:e.data.user,image:l}).then(function(e){return o.getChallenges(e.facebookId)}).then(function(n){console.log(n),openFB.api({path:"/me/friends",success:function(o){e.data.friends=[];for(var a=0;a<o.data.length;a++){var r=o.data[a];i.userInfo(r.id).then(function(t){t.status="start";for(var o=0;o<n.length;o++){if(n[o].challenged===t.facebookId){t.status="challenged",t.game=n[o];break}if(n[o].creator===t.facebookId){t.status="creator",t.game=n[o];break}}e.data.friends.push(t)})}t.go("friends")},error:function(e){window.localStorage.clear(),window.sessionStorage.clear(),t.go("frontPage"),console.log(e)}})}),e.toGame=function(o){if(e.chosen=!0,"start"===o.status){var a=localStorage.getItem("FBuserID")||"default",s={creator:a,challenged:o.facebookId};e.makeGame(s).then(function(e){console.log(e.data),n.localStorage.setItem("currentGame",e.data._id);var o=r.getData();t.go(o?"deckOptions":"hanziOptions")})}else n.localStorage.setItem("currentGame",o.game._id),t.go("game")}})}),angular.module("starter.game",[]).controller("GameCtrl",function(e,e,t,n,o){e.gameStatus={},e.gameStatus.counter=0,e.gameStatus.numCorrect=0,e.gameStatus.cards=[],e.gameStatus.hanziType=n.localStorage.getItem("hanziOptions")||"tradHanzi",e.shuffle=function(){for(var t=[],n=0;n<e.data.game.deck.length;n++)n!==e.gameStatus.counter&&t.push(e.data.game.deck[n]);for(var o=[],n=0;3>n;n++){var a=Math.floor(Math.random()*t.length);o.push(t[a]),t.splice(a,1)}var r=Math.floor(4*Math.random()),s=e.data.game.deck[e.gameStatus.counter];o.splice(r,0,s),e.gameStatus.cards=o},e.getGame=o.getGame,e.data={},e.data.gameId=n.localStorage.getItem("currentGame"),e.getGame(e.data.gameId).then(function(t){console.log(t.data),e.data.game=t.data,e.data.game.deck=t.data.deck,e.shuffle()}),e.next=function(a){if(a===e.data.game.deck[e.gameStatus.counter]&&e.gameStatus.numCorrect++,e.gameStatus.counter++,e.gameStatus.counter<e.data.game.deck.length)e.shuffle();else{var r=e.data.game.creator===n.localStorage.getItem("FBuserID");n.localStorage.setItem("lastScore",e.gameStatus.numCorrect),o.update(e.data.gameId,{lastScore:e.gameStatus.numCorrect,creator:r}).then(function(e){console.log("Update response:"),console.log(e)}),t.go("results")}}}),angular.module("starter.hanziOptions",[]).controller("HanziOptionsCtrl",function(e,t,n,o){o.checkLoginStatus(function(){e.value=n.getData(),e.options=[{title:"Traditional",pinyin:"fántǐzì",hanzi:"繁體字",code:"tradHanzi"},{title:"Simplified",pinyin:"jiǎntizì ",hanzi:"简体字",code:"simpleHanzi"},{title:"Pinyin",pinyin:"pīnyīn",hanzi:"pīnyīn",code:"pinyin"}],e.latestData=function(){return n.getData()},e.update=function(e){return console.log("value",e),n.setData(e)}})}),angular.module("starter.results",[]).controller("ResultsCtrl",function(e,t,n){e.resultStatus={},e.resultStatus.numCorrect=n.localStorage.getItem("lastScore"),e.return=function(){t.go("friends")}});